<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Student Exchange Review</title>
    <!-- Load libraries in specific order -->
    <script crossorigin src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
    <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <script src="https://unpkg.com/@supabase/supabase-js@2/dist/umd/supabase.js"></script>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        .star-button {
            background: none;
            border: none;
            font-size: 24px;
            cursor: pointer;
            color: #d1d5db;
            transition: color 0.2s;
        }
        .star-button.filled {
            color: #fbbf24;
        }
        .star-button:disabled {
            cursor: default;
        }
    </style>
</head>
<body>
    <div id="root">
        <div style="padding: 20px; text-align: center;">
            <p>Loading...</p>
            <p id="error-message" style="color: red; display: none;">Error loading libraries. Check console for details.</p>
        </div>
    </div>

    <script type="text/babel">
        // Check if all libraries loaded
        if (typeof React === 'undefined') {
            document.getElementById('error-message').style.display = 'block';
            document.getElementById('error-message').textContent = 'React failed to load';
            throw new Error('React not loaded');
        }
        if (typeof ReactDOM === 'undefined') {
            document.getElementById('error-message').style.display = 'block';
            document.getElementById('error-message').textContent = 'ReactDOM failed to load';
            throw new Error('ReactDOM not loaded');
        }
        if (typeof supabase === 'undefined') {
            document.getElementById('error-message').style.display = 'block';
            document.getElementById('error-message').textContent = 'Supabase failed to load';
            throw new Error('Supabase not loaded');
        }

        const { useState, useMemo } = React;

        // Initialize Supabase
        const supabaseUrl = 'https://aojighzqmzouwhxyndbs.supabase.co';
        const supabaseKey = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImFvamlnaHpxbXpvdXdoeHluZGJzIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTI0MDgyNTMsImV4cCI6MjA2Nzk4NDI1M30.1f2HHXbYxP8KaABhv4uw151Xj1mRDWxd63pHYgKIXnQ';
        
        const { createClient } = supabase;
        const supabaseClient = createClient(supabaseUrl, supabaseKey);

        const WriteReview = () => {
            const [selectedCountry, setSelectedCountry] = useState('');
            const [selectedUniversity, setSelectedUniversity] = useState('');
            const [courseStudied, setCourseStudied] = useState('');
            const [gpa, setGpa] = useState('');
            const [academicRating, setAcademicRating] = useState(0);
            const [academicComment, setAcademicComment] = useState('');
            const [cultureRating, setCultureRating] = useState(0);
            const [cultureComment, setCultureComment] = useState('');
            const [foodRating, setFoodRating] = useState(0);
            const [foodComment, setFoodComment] = useState('');
            const [accommodationRating, setAccommodationRating] = useState(0);
            const [accommodationComment, setAccommodationComment] = useState('');
            const [safetyRating, setSafetyRating] = useState(0);
            const [safetyComment, setSafetyComment] = useState('');
            const [selectedTags, setSelectedTags] = useState([]);
            const [reviewText, setReviewText] = useState('');
            const [tipsText, setTipsText] = useState('');
            const [isSubmitting, setIsSubmitting] = useState(false);
            const [submitMessage, setSubmitMessage] = useState('');

            // Auto-compute overall rating
            const computedOverallRating = useMemo(() => {
                const ratings = [academicRating, cultureRating, foodRating, accommodationRating, safetyRating];
                const validRatings = ratings.filter(rating => rating > 0);
                if (validRatings.length === 0) return 0;
                const average = validRatings.reduce((sum, rating) => sum + rating, 0) / validRatings.length;
                return Math.round(average);
            }, [academicRating, cultureRating, foodRating, accommodationRating, safetyRating]);

            const countries = [
                'Australia', 'Austria', 'Belgium', 'Canada', 'China', 'Denmark', 'Finland', 
                'France', 'Germany', 'Hong Kong', 'Italy', 'Japan', 'Netherlands', 'New Zealand',
                'Norway', 'South Korea', 'Spain', 'Sweden', 'Switzerland', 'United Kingdom', 'United States'
            ];

            const universities = {
                'United States': ['Harvard University', 'Stanford University', 'MIT', 'UC Berkeley', 'NYU'],
                'United Kingdom': ['Oxford University', 'Cambridge University', 'Imperial College London', 'UCL', 'LSE'],
                'Australia': ['University of Melbourne', 'Australian National University', 'University of Sydney', 'UNSW'],
                'Canada': ['University of Toronto', 'UBC', 'McGill University', 'University of Waterloo'],
                'Germany': ['Technical University of Munich', 'Heidelberg University', 'Humboldt University'],
                'France': ['Sorbonne University', 'École Normale Supérieure', 'Sciences Po'],
                'Japan': ['University of Tokyo', 'Kyoto University', 'Waseda University', 'Keio University'],
                'South Korea': ['Seoul National University', 'KAIST', 'Yonsei University', 'Korea University'],
                'China': ['Peking University', 'Tsinghua University', 'Fudan University', 'Shanghai Jiao Tong University'],
                'Netherlands': ['University of Amsterdam', 'Delft University of Technology', 'Erasmus University'],
                'Sweden': ['KTH Royal Institute of Technology', 'Stockholm University', 'Lund University'],
                'Switzerland': ['ETH Zurich', 'University of Zurich', 'EPFL'],
                'Italy': ['Bocconi University', 'University of Bologna', 'Sapienza University of Rome'],
                'Spain': ['IE University', 'Universidad Carlos III de Madrid', 'University of Barcelona'],
                'Norway': ['University of Oslo', 'Norwegian University of Science and Technology'],
                'Denmark': ['University of Copenhagen', 'Technical University of Denmark'],
                'Finland': ['University of Helsinki', 'Aalto University'],
                'Austria': ['University of Vienna', 'Vienna University of Technology'],
                'Belgium': ['KU Leuven', 'Ghent University'],
                'Hong Kong': ['University of Hong Kong', 'HKUST', 'Chinese University of Hong Kong'],
                'New Zealand': ['University of Auckland', 'University of Otago']
            };

            const experienceTags = [
                'Life-changing', 'Academically Rigorous', 'Culturally Enriching', 'Great Social Life',
                'Career Boost', 'Language Learning', 'Travel Opportunities', 'Diverse Community'
            ];

            const StarRating = ({ rating, setRating, label, readOnly = false, comment, setComment, placeholder }) => {
                return (
                    <div className="mb-6">
                        <label className="block text-sm font-medium text-gray-700 mb-2">
                            {label} *
                            {readOnly && <span className="text-sm text-gray-500 ml-2">(Auto-calculated)</span>}
                        </label>
                        <div className="flex gap-1 mb-3">
                            {[1, 2, 3, 4, 5].map((star) => (
                                <button
                                    key={star}
                                    type="button"
                                    onClick={() => !readOnly && setRating(star)}
                                    className={`star-button ${star <= rating ? 'filled' : ''}`}
                                    disabled={readOnly}
                                >
                                    ★
                                </button>
                            ))}
                        </div>
                        {!readOnly && (
                            <textarea
                                value={comment}
                                onChange={(e) => setComment(e.target.value)}
                                placeholder={placeholder}
                                className="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500 resize-vertical"
                                rows="3"
                            />
                        )}
                    </div>
                );
            };

            const handleTagClick = (tag) => {
                if (selectedTags.includes(tag)) {
                    setSelectedTags(selectedTags.filter(t => t !== tag));
                } else {
                    setSelectedTags([...selectedTags, tag]);
                }
            };

            const handleSubmit = async () => {
                setIsSubmitting(true);
                setSubmitMessage('');

                try {
                    const reviewData = {
                        country: selectedCountry,
                        university: selectedUniversity,
                        course_studied: courseStudied,
                        gpa: parseFloat(gpa),
                        overall_rating: computedOverallRating,
                        academic_rating: academicRating,
                        academic_comment: academicComment,
                        culture_rating: cultureRating,
                        culture_comment: cultureComment,
                        food_rating: foodRating,
                        food_comment: foodComment,
                        accommodation_rating: accommodationRating,
                        accommodation_comment: accommodationComment,
                        safety_rating: safetyRating,
                        safety_comment: safetyComment,
                        tags: selectedTags,
                        review_text: reviewText,
                        tips_text: tipsText
                    };

                    const { data, error } = await supabaseClient
                        .from('reviews')
                        .insert([reviewData]);

                    if (error) {
                        throw error;
                    }

                    setSubmitMessage('Review submitted successfully! Thank you for sharing your experience.');
                    
                    // Reset form
                    setSelectedCountry('');
                    setSelectedUniversity('');
                    setCourseStudied('');
                    setGpa('');
                    setAcademicRating(0);
                    setAcademicComment('');
                    setCultureRating(0);
                    setCultureComment('');
                    setFoodRating(0);
                    setFoodComment('');
                    setAccommodationRating(0);
                    setAccommodationComment('');
                    setSafetyRating(0);
                    setSafetyComment('');
                    setSelectedTags([]);
                    setReviewText('');
                    setTipsText('');

                } catch (error) {
                    console.error('Error submitting review:', error);
                    setSubmitMessage('Error submitting review. Please try again.');
                } finally {
                    setIsSubmitting(false);
                }
            };

            return (
                <div className="min-h-screen bg-gray-50 py-8">
                    <div className="max-w-2xl mx-auto px-4">
                        <div className="bg-white rounded-lg shadow-sm p-8">
                            <div className="flex items-center gap-3 mb-8">
                                <div className="w-8 h-8 bg-blue-600 rounded flex items-center justify-center">
                                    <span className="text-white font-bold text-sm">SMU</span>
                                </div>
                                <h1 className="text-2xl font-bold text-gray-900">Write a Review</h1>
                            </div>

                            <div className="space-y-6">
                                {/* Country Selection */}
                                <div>
                                    <label className="block text-sm font-medium text-gray-700 mb-2">
                                        Country of Exchange *
                                    </label>
                                    <div className="relative">
                                        <select
                                            value={selectedCountry}
                                            onChange={(e) => {
                                                setSelectedCountry(e.target.value);
                                                setSelectedUniversity('');
                                            }}
                                            className="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500 appearance-none bg-white"
                                            required
                                        >
                                            <option value="">Select a Country</option>
                                            {countries.map(country => (
                                                <option key={country} value={country}>{country}</option>
                                            ))}
                                        </select>
                                    </div>
                                </div>

                                {/* University Selection */}
                                {selectedCountry && (
                                    <div>
                                        <label className="block text-sm font-medium text-gray-700 mb-2">
                                            University *
                                        </label>
                                        <div className="relative">
                                            <select
                                                value={selectedUniversity}
                                                onChange={(e) => setSelectedUniversity(e.target.value)}
                                                className="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500 appearance-none bg-white"
                                                required
                                            >
                                                <option value="">Select a University</option>
                                                {universities[selectedCountry]?.map(uni => (
                                                    <option key={uni} value={uni}>{uni}</option>
                                                ))}
                                            </select>
                                        </div>
                                    </div>
                                )}

                                {/* Course Studied */}
                                <div>
                                    <label className="block text-sm font-medium text-gray-700 mb-2">
                                        Course Studied *
                                    </label>
                                    <input
                                        type="text"
                                        value={courseStudied}
                                        onChange={(e) => setCourseStudied(e.target.value)}
                                        placeholder="Enter your course/major (e.g., Business Administration, Computer Science)"
                                        className="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500"
                                        required
                                    />
                                </div>

                                {/* GPA Input */}
                                <div>
                                    <label className="block text-sm font-medium text-gray-700 mb-2">
                                        GPA *
                                    </label>
                                    <input
                                        type="number"
                                        value={gpa}
                                        onChange={(e) => setGpa(e.target.value)}
                                        placeholder="Enter your GPA (e.g., 3.5)"
                                        min="0"
                                        max="4"
                                        step="0.01"
                                        className="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500"
                                        required
                                    />
                                </div>

                                {/* Divider Line */}
                                <div className="border-t border-gray-200 my-6"></div>

                                {/* Overall Rating */}
                                <StarRating 
                                    rating={computedOverallRating} 
                                    setRating={() => {}} 
                                    label="Overall Rating" 
                                    readOnly={true}
                                />

                                {/* Academic Experience Rating */}
                                <StarRating 
                                    rating={academicRating} 
                                    setRating={setAcademicRating} 
                                    label="Academic Experience" 
                                    comment={academicComment}
                                    setComment={setAcademicComment}
                                    placeholder="Share your thoughts on courses, professors, academic quality, workload, etc."
                                />

                                {/* Cultural Experience Rating */}
                                <StarRating 
                                    rating={cultureRating} 
                                    setRating={setCultureRating} 
                                    label="Cultural Experience" 
                                    comment={cultureComment}
                                    setComment={setCultureComment}
                                    placeholder="Describe your cultural immersion, local customs, social interactions, etc."
                                />

                                {/* Food Rating */}
                                <StarRating 
                                    rating={foodRating} 
                                    setRating={setFoodRating} 
                                    label="Food" 
                                    comment={foodComment}
                                    setComment={setFoodComment}
                                    placeholder="Tell us about local cuisine, dining options, food quality, etc."
                                />

                                {/* Accommodation Rating */}
                                <StarRating 
                                    rating={accommodationRating} 
                                    setRating={setAccommodationRating} 
                                    label="Accommodation" 
                                    comment={accommodationComment}
                                    setComment={setAccommodationComment}
                                    placeholder="Share details about housing quality, facilities, location, etc."
                                />

                                {/* Safety Rating */}
                                <StarRating 
                                    rating={safetyRating} 
                                    setRating={setSafetyRating} 
                                    label="Safety" 
                                    comment={safetyComment}
                                    setComment={setSafetyComment}
                                    placeholder="Describe your feelings about personal safety, campus security, neighborhood safety, etc."
                                />

                                {/* Experience Tags */}
                                <div>
                                    <label className="block text-sm font-medium text-gray-700 mb-2">
                                        What did you love about your exchange? *
                                    </label>
                                    <div className="flex flex-wrap gap-2">
                                        {experienceTags.map(tag => (
                                            <button
                                                key={tag}
                                                type="button"
                                                onClick={() => handleTagClick(tag)}
                                                className={`px-4 py-2 rounded-full text-sm font-medium transition-colors ${
                                                    selectedTags.includes(tag)
                                                        ? 'bg-blue-100 text-blue-700 border-2 border-blue-200'
                                                        : 'bg-gray-100 text-gray-700 border-2 border-transparent hover:bg-gray-200'
                                                }`}
                                            >
                                                {tag}
                                            </button>
                                        ))}
                                    </div>
                                </div>

                                {/* Review Text */}
                                <div>
                                    <label className="block text-sm font-medium text-gray-700 mb-2">
                                        Overall exchange experience *
                                    </label>
                                    <textarea
                                        value={reviewText}
                                        onChange={(e) => setReviewText(e.target.value)}
                                        placeholder="Share your overall thoughts about your exchange journey, key highlights, and any additional insights..."
                                        className="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500 resize-vertical"
                                        rows="6"
                                        required
                                    />
                                </div>

                                {/* Tips */}
                                <div>
                                    <label className="block text-sm font-medium text-gray-700 mb-2">
                                        Tips for future exchange students
                                    </label>
                                    <textarea
                                        value={tipsText}
                                        onChange={(e) => setTipsText(e.target.value)}
                                        placeholder="Any advice for students considering this exchange program?"
                                        className="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500 resize-vertical"
                                        rows="4"
                                    />
                                </div>

                                {/* Submit Button */}
                                <div className="flex justify-end pt-6">
                                    {submitMessage && (
                                        <div className={`mr-4 p-3 rounded-lg text-sm ${
                                            submitMessage.includes('Error') 
                                                ? 'bg-red-100 text-red-700' 
                                                : 'bg-green-100 text-green-700'
                                        }`}>
                                            {submitMessage}
                                        </div>
                                    )}
                                    <button
                                        type="button"
                                        onClick={handleSubmit}
                                        disabled={isSubmitting}
                                        className={`px-8 py-3 font-medium rounded-lg transition-colors focus:ring-2 focus:ring-blue-500 focus:ring-offset-2 ${
                                            isSubmitting 
                                                ? 'bg-gray-400 text-gray-700 cursor-not-allowed' 
                                                : 'bg-blue-600 text-white hover:bg-blue-700'
                                        }`}
                                    >
                                        {isSubmitting ? 'Submitting...' : 'Submit Review'}
                                    </button>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            );
        };

        // Render the component
        ReactDOM.render(<WriteReview />, document.getElementById('root'));
    </script>
</body>
</html>